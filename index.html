<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTable Dash v4</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS (Excel İşlemleri) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js (Grafikler) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 pb-10">

<div id="app" class="max-w-[1500px] mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-3xl shadow-sm border border-slate-200">
        <div class="flex items-center gap-3">
            <div class="w-11 h-11 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-100">
                <i data-lucide="grid-2x2" class="text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight italic">SmartTable Dash</h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Veri Analiz Sistemi</p>
            </div>
        </div>

        <div class="flex items-center gap-3" id="navControls" style="display: none;">
            <div class="flex bg-slate-50 p-1.5 rounded-2xl border border-slate-100">
                <button onclick="switchTab('data')" id="btn-data" class="tab-btn px-5 py-2 rounded-xl text-xs font-bold transition-all bg-white text-indigo-600 shadow-md">
                    <span class="flex items-center gap-2"><i data-lucide="table" size="14"></i> Veri Girişi</span>
                </button>
                <button onclick="switchTab('charts')" id="btn-charts" class="tab-btn px-5 py-2 rounded-xl text-xs font-bold transition-all text-slate-500 hover:text-slate-800">
                    <span class="flex items-center gap-2"><i data-lucide="bar-chart-3" size="14"></i> Analiz Paneli</span>
                </button>
            </div>
            <div class="flex gap-2">
                <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls, .csv">
                <label for="excel-upload" class="cursor-pointer flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all">
                    <i data-lucide="upload" size="14"></i> Excel Yükle
                </label>
            </div>
        </div>
    </header>

    <!-- Setup Screen -->
    <div id="setup-screen" class="max-w-xl mx-auto py-12 animate-fade-in">
        <div class="bg-white rounded-[3rem] p-10 border border-slate-200 shadow-2xl text-center relative overflow-hidden">
            <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-[2rem] flex items-center justify-center mx-auto mb-6">
                <i data-lucide="layout" size="40"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">Tablo Boyutunu Belirle</h2>
            <p class="text-slate-400 text-sm mb-8">Kaç satır ve sütunla başlamak istersiniz?</p>
            
            <div class="grid grid-cols-2 gap-6 mb-10 text-left">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Satır Sayısı</label>
                    <input type="number" id="input-rows" value="5" class="w-full p-4 bg-slate-50 border-none rounded-2xl focus:ring-4 focus:ring-indigo-100 outline-none font-bold text-center">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Sütun Sayısı</label>
                    <input type="number" id="input-cols" value="4" class="w-full p-4 bg-slate-50 border-none rounded-2xl focus:ring-4 focus:ring-indigo-100 outline-none font-bold text-center">
                </div>
            </div>

            <button onclick="initTable()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all flex items-center justify-center gap-3">
                <i data-lucide="plus-circle" size="24"></i> Tabloyu Oluştur
            </button>

            <div class="mt-8 pt-8 border-t border-slate-100 text-slate-400 text-xs">
                Veya elinizdeki dosyayı yükleyin:
                <label for="excel-upload" class="text-indigo-600 font-bold cursor-pointer hover:underline block mt-2">Dosya Seçin</label>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;" class="animate-fade-in space-y-6">
        <!-- Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats-bar">
            <!-- Stats rendered here -->
        </div>

        <!-- Data View -->
        <div id="tab-data-content" class="space-y-4">
            <div class="bg-white p-3 rounded-2xl border border-slate-200 flex flex-col sm:flex-row gap-4 items-center justify-between shadow-sm">
                <div class="flex flex-wrap gap-2 items-center">
                    <div class="relative w-full sm:w-64 group">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors" size="16"></i>
                        <input type="text" id="search-input" oninput="renderTable()" placeholder="Tabloda süz..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border-none rounded-xl focus:ring-4 focus:ring-indigo-50 outline-none text-xs font-bold transition-all">
                    </div>
                    <button onclick="addRow()" class="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100">
                        <i data-lucide="plus" size="16"></i> Satır Ekle
                    </button>
                    <button onclick="addColumn()" class="flex items-center gap-2 bg-white text-indigo-600 border border-indigo-100 px-5 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-50 transition-all">
                        <i data-lucide="plus-circle" size="16"></i> Sütun Ekle
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="exportExcel()" class="bg-emerald-50 text-emerald-600 p-2.5 rounded-xl hover:bg-emerald-600 hover:text-white transition-all" title="Excel İndir">
                        <i data-lucide="file-spreadsheet" size="20"></i>
                    </button>
                    <button onclick="resetApp()" class="bg-rose-50 text-rose-500 p-2.5 rounded-xl hover:bg-rose-600 hover:text-white transition-all" title="Tümünü Sıfırla">
                        <i data-lucide="trash-2" size="20"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar max-h-[65vh]">
                    <table id="main-table" class="w-full text-left border-separate border-spacing-0">
                        <!-- Table Head and Body rendered here -->
                    </table>
                </div>
                <div id="empty-state" class="py-20 text-center text-slate-300 flex flex-col items-center gap-4" style="display: none;">
                    <i data-lucide="mouse-pointer-2" size="48" class="opacity-10"></i>
                    <p class="font-bold text-sm">Veri girişi yapılmamış.</p>
                </div>
            </div>
        </div>

        <!-- Charts View -->
        <div id="tab-charts-content" style="display: none;" class="space-y-6">
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-wrap gap-6 items-center">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Gruplama:</span>
                    <select id="chart-x-select" onchange="renderCharts()" class="bg-slate-50 border-none rounded-lg px-4 py-2 text-xs font-bold text-indigo-600 outline-none ring-1 ring-slate-100 focus:ring-indigo-200 cursor-pointer"></select>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Sayısal Veri:</span>
                    <select id="chart-y-select" onchange="renderCharts()" class="bg-slate-50 border-none rounded-lg px-4 py-2 text-xs font-bold text-emerald-600 outline-none ring-1 ring-slate-100 focus:ring-emerald-200 cursor-pointer">
                        <option value="">(Satır Sayısı)</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[500px]">
                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm h-full flex flex-col">
                    <h3 class="text-xs font-black mb-6 flex items-center gap-2 text-slate-700 uppercase tracking-widest">
                        <i data-lucide="pie-chart" class="text-indigo-600" size="16"></i> Dağılım Analizi
                    </h3>
                    <div class="flex-1 min-h-0">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm h-full flex flex-col">
                    <h3 class="text-xs font-black mb-6 flex items-center gap-2 text-slate-700 uppercase tracking-widest">
                        <i data-lucide="bar-chart-3" class="text-emerald-600" size="16"></i> Kıyaslama Raporu
                    </h3>
                    <div class="flex-1 min-h-0">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center text-[10px] text-slate-400 font-bold uppercase tracking-widest">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
            Sistem Aktif: Dinamik Veri Yönetimi
        </div>
        <div>SmartTable Dashboard © 2026</div>
    </footer>
</div>

<script>
    let headers = [];
    let data = [];
    let activeTab = 'data';
    let charts = { pie: null, bar: null };

    // Initialize Lucide
    window.onload = () => {
        lucide.createIcons();
        document.getElementById('excel-upload').addEventListener('change', handleExcelUpload);
    };

    function initTable() {
        const rowsCount = parseInt(document.getElementById('input-rows').value) || 5;
        const colsCount = parseInt(document.getElementById('input-cols').value) || 4;

        headers = Array.from({ length: colsCount }, (_, i) => `Sütun ${i + 1}`);
        data = Array.from({ length: rowsCount }, (_, rowIndex) => {
            const row = { _id: Date.now() + rowIndex };
            headers.forEach(h => row[h] = "");
            return row;
        });

        startApp();
    }

    function startApp() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('navControls').style.display = 'flex';
        document.getElementById('main-content').style.display = 'block';
        updateChartSelectors();
        renderTable();
        renderStats();
        lucide.createIcons();
    }

    function switchTab(tab) {
        activeTab = tab;
        document.getElementById('tab-data-content').style.display = tab === 'data' ? 'block' : 'none';
        document.getElementById('tab-charts-content').style.display = tab === 'charts' ? 'block' : 'none';
        
        // Update button styles
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.className = "tab-btn px-5 py-2 rounded-xl text-xs font-bold transition-all text-slate-500 hover:text-slate-800";
        });
        const activeBtn = document.getElementById(`btn-${tab}`);
        activeBtn.className = "tab-btn px-5 py-2 rounded-xl text-xs font-bold transition-all bg-white text-indigo-600 shadow-md";
        
        if (tab === 'charts') renderCharts();
        lucide.createIcons();
    }

    function addRow() {
        const newRow = { _id: Date.now() };
        headers.forEach(h => newRow[h] = "");
        data.push(newRow);
        renderTable();
        renderStats();
    }

    function addColumn() {
        const newColName = `Sütun ${headers.length + 1}`;
        headers.push(newColName);
        data.forEach(row => row[newColName] = "");
        updateChartSelectors();
        renderTable();
        renderStats();
    }

    function deleteRow(idx) {
        data.splice(idx, 1);
        renderTable();
        renderStats();
    }

    function handleCellChange(rowIdx, header, val) {
        data[rowIdx][header] = val;
        renderStats();
    }

    function handleHeaderChange(headerIdx, val) {
        const oldName = headers[headerIdx];
        headers[headerIdx] = val;
        data.forEach(row => {
            row[val] = row[oldName];
            delete row[oldName];
        });
        updateChartSelectors();
        renderTable();
    }

    function renderTable() {
        const table = document.getElementById('main-table');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        const filtered = data.filter(row => 
            Object.values(row).some(v => String(v).toLowerCase().includes(searchTerm))
        );

        let html = `<thead><tr>`;
        headers.forEach((h, i) => {
            html += `
                <th class="sticky top-0 z-20 bg-slate-50/80 backdrop-blur-md px-6 py-5 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-200">
                    <div class="flex items-center gap-2">
                        <input value="${h}" onchange="handleHeaderChange(${i}, this.value)" class="bg-transparent border-none focus:ring-2 focus:ring-indigo-200 rounded px-1 outline-none text-indigo-600 font-black w-32">
                        <button onclick="removeColumn(${i})" class="text-rose-300 hover:text-rose-500 opacity-0 hover:opacity-100 transition-opacity">
                            <i data-lucide="x-circle" size="10"></i>
                        </button>
                    </div>
                </th>`;
        });
        html += `<th class="sticky top-0 z-20 bg-slate-50/80 backdrop-blur-md px-4 py-4 border-b border-slate-200 text-center"><i data-lucide="settings" size="14" class="text-slate-300 mx-auto"></i></th></tr></thead>`;

        html += `<tbody class="divide-y divide-slate-100">`;
        filtered.forEach((row, rIdx) => {
            html += `<tr class="hover:bg-slate-50/50 transition-colors group">`;
            headers.forEach(h => {
                const cellVal = row[h] || "";
                const cellClass = getCellClass(cellVal);
                html += `
                    <td class="px-3 py-2 border-r border-slate-50 last:border-none">
                        <input type="text" value="${cellVal}" 
                            oninput="handleCellChange(${data.indexOf(row)}, '${h}', this.value)" 
                            class="w-full px-3 py-2 rounded-lg text-xs font-medium outline-none border-transparent hover:border-slate-200 border transition-all focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 ${cellClass}">
                    </td>`;
            });
            html += `
                <td class="px-4 py-2 text-center">
                    <button onclick="deleteRow(${data.indexOf(row)})" class="opacity-0 group-hover:opacity-100 text-rose-300 hover:text-rose-500 transition-all">
                        <i data-lucide="trash-2" size="14"></i>
                    </button>
                </td></tr>`;
        });
        html += `</tbody>`;
        
        table.innerHTML = html;
        document.getElementById('empty-state').style.display = filtered.length === 0 ? 'flex' : 'none';
        lucide.createIcons();
    }

    function removeColumn(idx) {
        const name = headers[idx];
        headers.splice(idx, 1);
        data.forEach(row => delete row[name]);
        updateChartSelectors();
        renderTable();
    }

    function getCellClass(val) {
        const v = String(val).toLowerCase();
        if (['tamamlandı', 'yapıldı', 'bitti', 'evet', 'ok'].includes(v)) return 'text-emerald-600 font-bold bg-emerald-50/50';
        if (['beklemede', 'hayır', 'iptal', 'yapılmadı'].includes(v)) return 'text-rose-600 font-bold bg-rose-50/50';
        if (['devam', 'aktif', 'çalışılıyor'].includes(v)) return 'text-amber-600 font-bold bg-amber-50/50';
        return 'text-slate-600';
    }

    function renderStats() {
        const statsBar = document.getElementById('stats-bar');
        const xKey = document.getElementById('chart-x-select')?.value || headers[0];
        const yKey = document.getElementById('chart-y-select')?.value;
        
        let totalVal = data.length;
        if(yKey) {
            totalVal = data.reduce((sum, r) => sum + (parseFloat(String(r[yKey]).replace(',', '.')) || 0), 0);
        }

        const stats = [
            { label: "Toplam Kayıt", val: data.length, icon: "layers", color: "text-indigo-600 bg-indigo-50" },
            { label: "Toplam Değer", val: totalVal.toLocaleString('tr-TR'), icon: "trending-up", color: "text-emerald-600 bg-emerald-50" },
            { label: "Sütun Sayısı", val: headers.length, icon: "type", color: "text-rose-600 bg-rose-50" },
            { label: "Durum", val: "Aktif", icon: "activity", color: "text-amber-600 bg-amber-50" }
        ];

        statsBar.innerHTML = stats.map(s => `
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${s.color}">
                    <i data-lucide="${s.icon}" size="18"></i>
                </div>
                <div class="overflow-hidden">
                    <p class="text-[9px] font-black uppercase text-slate-400 leading-none mb-1 truncate">${s.label}</p>
                    <p class="text-sm font-black text-slate-800 truncate">${s.val}</p>
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    }

    function updateChartSelectors() {
        const xSel = document.getElementById('chart-x-select');
        const ySel = document.getElementById('chart-y-select');
        
        const currentX = xSel.value;
        const currentY = ySel.value;

        xSel.innerHTML = headers.map(h => `<option value="${h}" ${h === currentX ? 'selected' : ''}>${h}</option>`).join('');
        ySel.innerHTML = `<option value="">(Satır Sayısı)</option>` + 
            headers.map(h => `<option value="${h}" ${h === currentY ? 'selected' : ''}>${h}</option>`).join('');
    }

    function renderCharts() {
        const xKey = document.getElementById('chart-x-select').value;
        const yKey = document.getElementById('chart-y-select').value;

        if(!xKey) return;

        const counts = {};
        const sums = {};

        data.forEach(row => {
            const label = row[xKey] || 'Boş';
            counts[label] = (counts[label] || 0) + 1;
            const val = yKey ? parseFloat(String(row[yKey]).replace(',', '.')) || 0 : 1;
            sums[label] = (sums[label] || 0) + val;
        });

        const sortedLabels = Object.keys(sums).sort((a,b) => sums[b] - sums[a]).slice(0, 10);
        const pieLabels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 10);

        const pieData = pieLabels.map(l => counts[l]);
        const barData = sortedLabels.map(l => sums[l]);

        if (charts.pie) charts.pie.destroy();
        if (charts.bar) charts.bar.destroy();

        charts.pie = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f43f5e']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        charts.bar = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: yKey || 'Kayıt Sayısı',
                    data: barData,
                    backgroundColor: '#6366f1',
                    borderRadius: 10
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
            }
        });
    }

    function handleExcelUpload(e) {
        const file = e.target.files[0];
        if (!file || !window.XLSX) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary', cellDates: true });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

            if (json.length > 0) {
                let headerIdx = 0;
                let maxCols = 0;
                for (let i = 0; i < Math.min(json.length, 12); i++) {
                    const filledCount = json[i].filter(cell => String(cell).trim() !== "").length;
                    if (filledCount > maxCols) { maxCols = filledCount; headerIdx = i; }
                }

                headers = json[headerIdx].map((h, i) => String(h || "").trim() || `Sütun ${i + 1}`);
                data = json.slice(headerIdx + 1)
                    .filter(row => row.some(cell => String(cell).trim() !== ""))
                    .map((row, idx) => {
                        const obj = { _id: Date.now() + idx };
                        headers.forEach((h, i) => {
                            let val = row[i];
                            obj[h] = val instanceof Date ? val.toLocaleDateString('tr-TR') : String(val ?? '').trim();
                        });
                        return obj;
                    });
                
                startApp();
            }
        };
        reader.readAsBinaryString(file);
    }

    function exportExcel() {
        const exportable = data.map(row => {
            const { _id, ...rest } = row;
            return rest;
        });
        const ws = XLSX.utils.json_to_sheet(exportable);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Rapor");
        XLSX.writeFile(wb, "Veri_Analiz_Raporu.xlsx");
    }

    function resetApp() {
        headers = [];
        data = [];
        document.getElementById('setup-screen').style.display = 'block';
        document.getElementById('navControls').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';
    }
</script>
</body>
</html>
